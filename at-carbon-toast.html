<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="izi-toast-template.html" />

<script src="lib/iziToast.js"></script>
<link rel="stylesheet" type="text/css" href="lib/iziToast.css">
<link rel="stylesheet" type="text/css" href="iziToast-override.css">

<dom-module id="at-carbon-toast">
  <style>
   :host {
    display: none;
  }
  </style>
  <template>
  </template>
</dom-module>
<script>
(function() {

  // Keeps track of the toast currently opened.
  var currentToast = null;

  Polymer({
    is: "at-carbon-toast",

    behaviors: [
      Polymer.IronOverlayBehavior
    ],

    properties: {
      /**
       * The element to fit `this` into.
       * Overridden from `Polymer.IronFitBehavior`.
       */
      fitInto: {
        type: Object,
        value: window,
        observer: '_onFitIntoChanged'
      },

      /**
       * Toast position on the screen.
       * Possible values are bottomRight, bottomLeft, bottomCenter, topRight, topLeft, topCenter and center
       *
       * @property toastPosition
       * @type String
       * @default bottomLeft 
       */
       // position is renamed to toast position because ironfitbehavior has position function and that function takes over if toastPosition is named position
      toastPosition: {
        type: String,
        value: 'bottomLeft',
        xtype: 'enum',
        xvaluelist:[{
          title: "Bottom left",
          value: "bottomLeft"
        }, {
          title: "Bottom right",
          value: "bottomRight"
        }, {
          title: "Bottom center",
          value: "bottomCenter"
        }, {
          title: "Top left",
          value: "topLeft"
        }, {
          title: "Top right",
          value: "topRight"
        }, {
          title: "Top center",
          value: "topCenter"
        }, {
          title: "Center",
          value: "center"
        }]
      },

      /**
       * animation used when toast is shown
       * 
       * @property showAnimation
       * @type string
       * @default fadeInUp
       */
      showAnimation: {
        type: String,
        value: "fadeInUp",
        xtype: 'enum',
        xvaluelist: [{
          title: "bounceInLeft",
          value: "bounceInLeft"
        }, {
          title: "bounceInRight",
          value: "bounceInRight"
        }, {
          title: "bounceInUp",
          value: "bounceInUp"
        }, {
          title: "bounceInDown",
          value: "bounceInDown"
        }, {
          title: "fadeIn",
          value: "fadeIn"
        }, {
          title: "fadeInDown",
          value: "fadeInDown"
        }, {
          title: "fadeInUp",
          value: "fadeInUp"
        }, {
          title: "fadeInLeft",
          value: "fadeInLeft"
        }, {
          title: "fadeInRight",
          value: "fadeInRight"
        }, {
          title: "flipInX",
          value: "flipInX"
        }]
      },

      /**
       * now:icon to be displyed to the left of message text
       * 
       * @property icon
       * @type String
       * @default "" 
       */
      icon: {
        type: String,
        value: ""
      },

      /**
       * The duration in milliseconds to show the toast.
       * Set to `0`, a negative number, or `Infinity`, to disable the
       * toast auto-closing.
       */
      duration: {
        type: Number,
        value: 3000
      },

      /**
       * The text to display in the toast.
       */
      text: {
        type: String,
        value: ''
      },

      /**
       * Overridden from `IronOverlayBehavior`.
       * Set to false to enable closing of the toast by clicking outside it.
       */
      noCancelOnOutsideClick: {
        type: Boolean,
        value: true
      },

      /**
       * Overridden from `IronOverlayBehavior`.
       * Set to true to disable auto-focusing the toast or child nodes with
       * the `autofocus` attribute` when the overlay is opened.
       */
      noAutoFocus: {
        type: Boolean,
        value: true
      }
    },

    listeners: {
      'transitionend': '__onTransitionEnd'
    },

    /**
     * Read-only. Deprecated. Use `opened` from `IronOverlayBehavior`.
     * @property visible
     * @deprecated
     */
    get visible() {
      Polymer.Base._warn('`visible` is deprecated, use `opened` instead');
      return this.opened;
    },

    /**
     * Read-only. Can auto-close if duration is a positive finite number.
     * @property _canAutoClose
     */
    get _canAutoClose() {
      return this.duration > 0 && this.duration !== Infinity;
    },

    created: function() {
      this._autoClose = null;
      Polymer.IronA11yAnnouncer.requestAvailability();
    },

    /**
     * Show the toast. Without arguments, this is the same as `open()` from `IronOverlayBehavior`.
     * @param {(Object|string)=} properties Properties to be set before opening the toast.
     * e.g. `toast.show('hello')` or `toast.show({text: 'hello', duration: 3000})`
     */
    show: function(properties) {
      if (typeof properties == 'string') {
        properties = { text: properties };
      }
      for (var property in properties) {
        if (property.indexOf('_') === 0) {
          Polymer.Base._warn('The property "' + property + '" is private and was not set.');
        } else if (property in this) {
          this[property] = properties[property];
        } else {
          Polymer.Base._warn('The property "' + property + '" is not valid.');
        }
      }

      if (this.opened) {
        this._showIziToast();
      } else {
        this.open();        
      }
    },

    /**
     * Hide the toast. Same as `close()` from `IronOverlayBehavior`.
     */
    hide: function() {
      this._hideIziToast();

      this.close();
    },

    /**
     * Called on transitions of the toast, indicating a finished animation
     * @private
     */
    __onTransitionEnd: function(e) {
      // there are different transitions that are happening when opening and
      // closing the toast. The last one so far is for `opacity`.
      // This marks the end of the transition, so we check for this to determine if this
      // is the correct event.
      if (e && e.target === this && e.propertyName === 'opacity') {
        if (this.opened) {
          this._finishRenderOpened();
        } else {
          this._finishRenderClosed();
        }
      }
    },

    /**
     * Overridden from `IronOverlayBehavior`.
     * Called when the value of `opened` changes.
     */
    _openedChanged: function() {
      if (this._autoClose !== null) {
        this.cancelAsync(this._autoClose);
        this._autoClose = null;
      }
      if (this.opened) {
        if (currentToast && currentToast !== this) {
          currentToast.close();
        }

        this._showIziToast();

        currentToast = this;
        this.fire('iron-announce', {
          text: this.text
        });
        if (this._canAutoClose) {
          this._autoClose = this.async(this.close, this.duration);
        }
      } else if (currentToast === this) {
        currentToast = null;
        this._hideIziToast();
      }

      Polymer.IronOverlayBehaviorImpl._openedChanged.apply(this, arguments);
    },

    _showIziToast: function() {
      var self = this;
      var iziToastPosition = this.toastPosition;
      iziToast.show({
        class: 'toast-query-handle',
        horizontalOffset: this.horizontalOffset,
        verticalOffset: this.verticalOffset,
        toastIcon: this.icon,
        message: this.text,
        position: iziToastPosition,
        close: false,
        progressBar: true,
        timeout: this.duration,
        transitionIn: this.showAnimation,
        onClose: function(event) {
          self.opened = false;
        }
      });
    },

    _hideIziToast: function() {
      var toasts = document.querySelectorAll('.toast-query-handle');
      toasts.forEach(function(toast, index) { 
        iziToast.hide({}, toast);
      });
    },

    /**
     * Overridden from `IronOverlayBehavior`.
     */
    _renderOpened: function() {
      this.classList.add('paper-toast-open');
    },

    /**
     * Overridden from `IronOverlayBehavior`.
     */
    _renderClosed: function() {
      this.classList.remove('paper-toast-open');
    },

    /**
     * @private
     */
    _onFitIntoChanged: function(fitInto) {
      this.positionTarget = fitInto;
    }
  });

})();
</script>
