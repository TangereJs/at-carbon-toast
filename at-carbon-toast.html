<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html" />
<link rel="import" href="../at-core-signals/at-core-signals.html"/>
<link rel="import" href="../paper-toast/paper-toast.html" />
<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../paper-styles/paper-styles.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="../iron-swipeable-container/iron-swipeable-container.html" />

<dom-module id="at-carbon-toast">
  <template strip-whitespace>
    <style>
      :host:not([disable-swipe]) iron-swipeable-container {
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        cursor: default;
      }

      paper-toast {
        @apply --paper-font-body2;
        @apply --layout-horizontal;
        @apply --layout-center;
        color: var(--paper-toast-color, #f1f1f1);
        background-color: var(--paper-toast-background-color, #323232);
        @apply --app-toast;
      }

      .content-container {
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      paper-button {
        color: var(--accent-color);
        @apply --app-toast-button;
      }

      #mainIcon {
        margin-right: 4px;
        @apply --app-toast-main-icon;
        --iron-icon-stroke-color: var(--app-toast-main-icon-stroke-color);
      }
  </style>

    <at-core-signals id="coreSignals" on-sys-error="_handleSysError" on-sys-info="_handleSysInfo" on-sys-warning="_handleSysWarning"></at-core-signals>

    <div id="container">
      <iron-swipeable-container id="swiper" on-iron-swipe="__onSwiped"> </iron-swipeable-container>

      <paper-toast id="toast" duration="[[duration]]" on-iron-overlay-closed="__onClosed">
        <at-carbon-icon id="mainIcon" icon="[[icon]]" hidden$="[[_hideIcon(icon)]]"></at-carbon-icon>

        <div class="content-container">
          <slot></slot>
          <span>[[text]]</span>
        </div>

        <paper-button id="actionButton" on-tap="_onAction" hidden$="[[_computeHiddenAction(actionLabel, actionSignalName)]]">[[actionLabel]]</paper-button>
        <paper-button id="action2Button" on-tap="_onAction2" hidden$="[[_computeHiddenAction(actionLabel2, actionSignalName2)]]">[[actionLabel2]]</paper-button>
      </paper-toast>
    </div>

  </template>
</dom-module>
<script>
  (function() {

    Polymer({
      is: "at-carbon-toast",

      properties: {

        opened: {
          type: Boolean,
          value: false,
          notify: true,
          observer: '_openedChanged'
        },

        /**
         * Toast position on the screen.
         * Possible values are bottomRight, bottomLeft, bottomCenter, topRight, topLeft, topCenter and center
         *
         * @property toastPosition
         * @type String
         * @default bottomLeft 
         */
        // position is renamed to toast position because ironfitbehavior has position function and that function takes over if toastPosition is named position
        toastPosition: {
          type: String,
          value: 'bottomLeft',
          xtype: 'enum',
          xvaluelist: [{
            title: "Bottom left",
            value: "bottomLeft"
          }, {
            title: "Bottom right",
            value: "bottomRight"
          }, {
            title: "Bottom center",
            value: "bottomCenter"
          }, {
            title: "Top left",
            value: "topLeft"
          }, {
            title: "Top right",
            value: "topRight"
          }, {
            title: "Top center",
            value: "topCenter"
          }, {
            title: "Center",
            value: "center"
          }]
        },

        /**
         * animation used when toast is shown
         * 
         * @property showAnimation
         * @type string
         * @default fadeInUp
         */
        showAnimation: {
          type: String,
          value: "fadeInUp",
          xtype: 'enum',
          xvaluelist: [{
            title: "bounceInLeft",
            value: "bounceInLeft"
          }, {
            title: "bounceInRight",
            value: "bounceInRight"
          }, {
            title: "bounceInUp",
            value: "bounceInUp"
          }, {
            title: "bounceInDown",
            value: "bounceInDown"
          }, {
            title: "fadeIn",
            value: "fadeIn"
          }, {
            title: "fadeInDown",
            value: "fadeInDown"
          }, {
            title: "fadeInUp",
            value: "fadeInUp"
          }, {
            title: "fadeInLeft",
            value: "fadeInLeft"
          }, {
            title: "fadeInRight",
            value: "fadeInRight"
          }, {
            title: "flipInX",
            value: "flipInX"
          }]
        },

        /**
         * now:icon to be displyed to the left of message text
         * 
         * @property icon
         * @type String
         * @default "" 
         */
        icon: {
          type: String,
          value: "now:info"
        },

        /**
         * The duration in milliseconds to show the toast.
         * Set to `0`, a negative number, or `Infinity`, to disable the
         * toast auto-closing.
         */
        duration: {
          type: Number,
          value: 3000
        },

        /**
         * The text to display in the toast.
         */
        text: {
          type: String,
          value: ''
        },

        /**
         * A pixel value that will be added to the position calculated for the
         * given `horizontalAlign`, in the direction of alignment. You can think
         * of it as increasing or decreasing the distance to the side of the
         * screen given by `horizontalAlign`.
         *
         * If `horizontalAlign` is "left", this offset will increase or decrease
         * the distance to the left side of the screen: a negative offset will
         * move the dropdown to the left; a positive one, to the right.
         *
         * Conversely if `horizontalAlign` is "right", this offset will increase
         * or decrease the distance to the right side of the screen: a negative
         * offset will move the dropdown to the right; a positive one, to the left.
         */
        horizontalOffset: {
          type: Number,
          value: 0,
          notify: true
        },

        /**
         * A pixel value that will be added to the position calculated for the
         * given `verticalAlign`, in the direction of alignment. You can think
         * of it as increasing or decreasing the distance to the side of the
         * screen given by `verticalAlign`.
         *
         * If `verticalAlign` is "top", this offset will increase or decrease
         * the distance to the top side of the screen: a negative offset will
         * move the dropdown upwards; a positive one, downwards.
         *
         * Conversely if `verticalAlign` is "bottom", this offset will increase
         * or decrease the distance to the bottom side of the screen: a negative
         * offset will move the dropdown downwards; a positive one, upwards.
         */
        verticalOffset: {
          type: Number,
          value: 0,
          notify: true
        },

        actionLabel: {
          type: String,
          value: ''
        },

        actionLabel2: {
          type: String,
          value: ''
        },

        actionSignalName: {
          type: String,
          value: ''
        },

        actionSignalName2: {
          type: String,
          value: ''
        },

        renderMode: {
          type: String,
          value: '0',
          observer: '_renderModeChanged',
          xtype: "enum",
          xvaluelist: [{
            title: "auto",
            value: "0"
          }, {
            title: "desktop",
            value: "1"
          }, {
            title: "mobile",
            value: "2"
          }],
        },

      },

      attached: function () {
        this._defaultProperties = {
          icon: this.icon,
          text: this.text,
          duration: this.duration,
          actionLabel: this.actionLabel,
          actionLabel2: this.actionLabel2,
          actionSignalName: this.actionSignalName,
          actionSignalName2: this.actionSignalName2,
        };
      },

      reset: function () {
        this._setProperties(this._defaultProperties);
      },

      show: function(properties) {
        this._setProperties(properties);
        this.$.toast.style.opacity = 1;
        Polymer.dom(this.$.swiper).appendChild(this.$.toast);
        this.$.toast.show(properties);
      },

      open: function () { this.show(); },

      close: function () {
        this.$.toast.close();

        if(this.opened == true) {
          this.opened = false;
        }
      },

      hide: function() {
        this.$.toast.close();
      },

      _renderModeChanged: function (newValue, oldValue) {
        var swiper = this.$.swiper;
        // auto - if mobile == true -> behave like mobile, otherwise -> behave like desktop
        if (newValue == "0") {
          if(Tangere.session.browser.mobile == true) {
            newValue = 2;
          } else {
            newValue = 1;
          }
        }

        // desktop render mode
        if (newValue == "1") {
          this._disableSwipe = true;
          swiper.disabled = true;
          this._fitBottom = false;
          this.$.toast.classList.remove('fit-bottom');
        }

        // mobile render mode
        if (newValue == "2") {
          this._disableSwipe = false;
          swiper.disabled = false;
          this._fitBottom = true;
          this.$.toast.classList.add('fit-bottom');
        }
      },

      _onAction: function (e) {
        this._signalData.actionLabel = this.actionLabel;
        this._signalData.actionSignalName = this.actionSignalName;

        Polymer.signal(this.actionSignalName, {
          data: this._signalData
        });
      },

      _onAction2: function (e) {
        this._signalData.actionLabel2 = this.actionLabel2;
        this._signalData.actionSignalName2 = this.actionSignalName2;

        Polymer.signal(this.actionSignalName2, {
          data: this._signalData
        });
      },

      _setProperties: function (properties) {
        if (properties) {
          for (var property in properties) {
            if (property in this && property.indexOf('_') != 0) {
              this[property] = properties[property];
              delete properties[property];
            }
          }
        }
      },

      _hideIcon: function (icon) {
        return !icon;
      },

      _computeHiddenAction: function (label, signalName) {
        if(label != '' && signalName != '') {
          return false;
        } else {
          return true;
        }
      },

      __onSwiped: function (e, data) {
        this.$.toast.style.opacity = 0;
        this._wasSwiped = true;
        this.close();
      },

      __onClosed: function (e, data) {
        if (this._wasSwiped) {
          // this._cancel(e);
          this._wasSwiped = false;
        }
        
        this.$.toast.style.transform = 'translate3d(0, 0, 0) rotate(0)';
      },

      _openedChanged: function(newValue, oldValue) {
        if(newValue == true) {
          this.open();
        } else {
          this.close();
        }
      },

      _handleSysError: function(e) {
        console.error(e.detail.data.message);
        this._signalData = e.detail.data;
        this.icon = 'now:error';
        this.text = e.detail.data.message;
        this.show();
      },

      _handleSysInfo: function(e) {
        console.info(e.detail.data.message);
        this._signalData = e.detail.data;
        this.icon = 'now:info';
        this.text = e.detail.data.message;
        this.show();
      },

      _handleSysWarning: function(e) {
        console.warn(e.detail.data.message);
        this._signalData = e.detail.data;
        this.icon = 'now:warning';
        this.text = e.detail.data.message;
        this.show();
      }

    });
  })();
</script>
